library(base)
library(rio) # swiss army knife for imports
library(plyr) # count occurences
library(dplyr) # data wrangling
library(tidyr) # data wrangling
library(ggplot2) # nice plots
library(stargazer) # nicer regression output which looks like a real publication
library(car) # scatterplots 
library(httr) # scraping from http sites
library(XML) # Tool for generating XML file
library(WDI) # Scraping Data from the World Bank 
library(countrycode) # provides world bank country codes 
library(DataCombine) #merge package
library(lubridate) #provides functions to extract date-time components
library(date) 
library(timeDate) #computational finance chronological objects
library(XLConnect) #integrates with excel output
library(chron)


############################
## THE GRAND MERGE
############################

try(setwd("/Users/laurencehendry/GoogleDrive/Master Thesis - Shared/Quantitative Sources/V-Lab Datasets/European_Firms")) 

all_files <- list.files()

# Create a NULL object to combine the individual files into
combined <- NULL

for (i in all_files) {
  # Load and combine only if the file is a csv
  if (tools::file_ext(i) == 'csv') {
    # Read file
    temp <- import(i)
    
    # Create file ID from the file name and move to the front
    file_id <- gsub(pattern = '.csv', replacement = '', i)
    message(file_id)
    temp$file_id <- file_id
    temp <- MoveFront(temp, 'file_id')
    
    # Bind to the main data frame
    combined <- bind_rows(combined, temp)
    
  } else {
    message('-- Not CSV --')
  }
}

############################
## RETRIEVE INFO FROM INDEX FILE
############################

try(setwd("/Users/laurencehendry/GoogleDrive/Master Thesis - Shared/Quantitative Sources/V-Lab Datasets/European_Firms")) 

names(combined)[1] <- 'Code'
combined$V8 = NULL

#Import Index file
combined2 <- merge(combined[, c("Code", "V1", "V2", "V3", "V4", "V5", "V6", "V7", "V9")], Index[, c("Code", "Trading.Name", "Country", "Status")])

#combined2 <- merge(Index[, c("Code", "Date in days since 1900", "Marginal Expected Shortfall (MES)", "Daily Variance for the firm that day", "Beta of the firm with respect to MSCI World Index (Rob Engle Dynamic Conditional Beta Model)", "Correlation of the firm to MSCI World Index (uses asymmetric dynamic conditional correlation model)", "Firm Leverage Ratio", "Firm Capital Shortfall (SRISK) (5.5% prudential capital ratio for Europe)", "Firm Market Capitalisation in USD")], Index[, c("Code", "Trading.name", "Country", "Status")])


############################
## RENAME THE VARIABLES for combined2
############################

#remember that the [n] refers to column number and we don't identify column by name/symbol

names(combined2)[2] <- 'DateDays'
names(combined2)[3] <- 'Marginal Expected Shortfall (MES)'
names(combined2)[4] <- 'Daily Variance for the firm that day'
names(combined2)[5] <- 'Beta of the firm with respect to MSCI World Index (Rob Engle Dynamic Conditional Beta Model)'
names(combined2)[6] <- 'Correlation of the firm to MSCI World Index (uses asymmetric dynamic conditional correlation model)'
names(combined2)[7] <- 'Firm Leverage Ratio'
names(combined2)[8] <- 'Firm Capital Shortfall (SRISK) (5.5% prudential capital ratio for Europe)'
names(combined2)[9] <- 'Firm Market Capitalisation in USD'

############################
## FORMAT THE DATE
############################
# http://datapub.cdlib.org/2014/04/10/abandon-all-hope-ye-who-enter-dates-in-excel/ 

combined2$DateProper <- as.Date(combined2$DateDays, origin = '1900-01-01')


############################
## EXPORT TO .CSV
############################

write.csv(combined2, "/Users/laurencehendry/GoogleDrive/Master Thesis - Shared/Quantitative Sources/V-Lab Datasets/European_Firms/Working/combined3.csv")



