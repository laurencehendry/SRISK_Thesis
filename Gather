############################
# Code to reshape data of NYU Stern Business School V-Lab SRISK 
# Written by Laurence Hendry l.hendry@mpp.hertie-school.org
# Created 08.11.2015
# Loads and merges the data and saves it in a format ready for analysis
############################
library(base)
library(rio) # swiss army knife for imports
library(plyr) # count occurences
library(dplyr) # data wrangling
library(tidyr) # data wrangling
library(ggplot2) # nice plots
library(stargazer) # nicer regression output which looks like a real publication
library(car) # scatterplots 
library(httr) # scraping from http sites
library(XML) # Tool for generating XML file
library(WDI) # Scraping Data from the World Bank 
library(countrycode) # provides world bank country codes 
library(DataCombine) # merge package
library(lubridate) # provides functions to extract date-time components

############################
## THE GRAND MERGE
############################

try(setwd("/Users/laurencehendry/GoogleDrive/Master Thesis - Shared/V-Lab Datasets/European_Firms")) 

all_files <- list.files()

# Create a NULL object to combine the individual files into
combined <- NULL

for (i in all_files) {
  # Load and combine only if the file is a csv
  if (tools::file_ext(i) == 'csv') {
    # Read file
    temp <- import(i)
    
    # Create file ID from the file name and move to the front
    file_id <- gsub(pattern = '.csv', replacement = '', i)
    message(file_id)
    temp$file_id <- file_id
    temp <- MoveFront(temp, 'file_id')
    
    # Bind to the main data frame
    combined <- bind_rows(combined, temp)
    
  } else {
    message('-- Not CSV --')
  }
}

############################
## RENAME THE VARIABLES
############################

combined$V8 = NULL

names(combined)[1] <- 'Firm/Bank Code'
names(combined)[2] <- 'Date'
names(combined)[3] <- 'Marginal Expected Shortfall (MES)'
names(combined)[4] <- 'Daily Variance for the firm that day'
names(combined)[5] <- 'Beta of the firm with respect to MSCI World Index (Rob Engle Dynamic COnditional Beta Model)'
names(combined)[6] <- 'Correlation of the firm to MSCI World Index (uses asymmetric dynamic conditional correlation model)'
names(combined)[7] <- 'Firm Leverage Ratio'
names(combined)[8] <- 'Firm Capital Shortfall (SRISK) (5.5% prudential capital ratio for Europe)'
names(combined)[9] <- 'Firm Market Capitalisation in USD'

############################
## FORMAT THE DATE
############################

?strptime #discover date-time conversion function possibilities
format(sys.Date(), "%a %b %d") # failed thought

# the dates were entered/formatted in excel. We can therefore seek matches with excel once this step is complete to later determine whether
# 1900-01-01 or 1904-01-01 were used as baselines for days (since these are the two start date conventions used by excel)

as.Date(36690, origin = "1900-01-01") # example for one value
dates <- as.Date("Date", origin = "1900-01-01") # attempt to convert entire date column





