############################
## Laurence Hendry
## R version used: RStudio 0.99.489 
## Hertie School MPP Thesis 
## Thanks to NYU Stern V-Lab for Dataset
############################

############################
## Load packages
############################

library(base)
library(rio) # swiss army knife for imports
library(plyr) # count occurences
library(dplyr) # data wrangling
library(tidyr) # data wrangling
library(ggplot2) # nice plots
library(stargazer) # nicer regression output which looks like a real publication
library(car) # scatterplots 
library(httr) # scraping from http sites
library(XML) # Tool for generating XML file
library(WDI) # Scraping Data from the World Bank
library(countrycode) # provides world bank country codes 
library(gplots)
library(knitr)
library(readstata13)
library(DataCombine)
library(lubridate)
library(strucchange)
library(plm)
library(sjPlot) # http://strengejacke.de/sjPlot/ 

############################
## Set the correct working directory
############################

setwd("/Users/laurencehendry/GoogleDrive/Master Thesis - Shared/Quantitative Sources/Special Folder/R Laurence Folder - 20.1.16")

############################
## .DTA from STATA as .CSV Import
############################

#import the .csv from STATA 13 (HolyGrail)

#rename variables correctly 
names(RHolyGrail)[1] <-'days'
names(RHolyGrail)[2] <-'MES'
names(RHolyGrail)[3] <-'dailyvariance'
names(RHolyGrail)[4] <-'mscibeta'
names(RHolyGrail)[5] <-'mscicorrelation'
names(RHolyGrail)[6] <-'firmleverage'
names(RHolyGrail)[7] <-'srisk'
names(RHolyGrail)[8] <-'marketcap'

#remove incorrectly formatted data columns
RHolyGrail[9]<- NULL
RHolyGrail[10] <- NULL
RHolyGrail$edate1 <- NULL

############################
## Get R to read dates correctly
############################

RHolyGrail$Date <- as.Date(RHolyGrail$days, origin = '1900-01-01')

#get a summary of the variables to check
summary(RHolyGrail)

############################
## Sub-set our data
############################
#unit is limited to AMC Aberdeen Asset Management 
RHolyGrail_subset1 <- subset(RHolyGrail, 
                             code_ordinal=="ADN_LN", 
                             start = c(2011-01-20))
?c
#time is limited to 



############################
## Panel regression with the 'plm' package
############################

RHolyGrail_sb <- pdata.frame(RHolyGrail_subset1)

#attempting to find an equivalent command to xtset 
#stumbled upon: http://www.rdocumentation.org/packages/qogdata/functions/xtset
#but 'xtset' does not appear supported in the plm package
#xtset(dataset = RHolyGrail,
#  data = c("code_ordinal", "Date"),
#  spec = c("tradingname_ordinal", "days"),
#  name = "srisk for companies, time series data")

############################
## Structural Break test
############################
# For structural break tests, see p.56-7 https://cran.r-project.org/web/packages/strucchange/strucchange.pdf 
# and https://cran.r-project.org/web/packages/strucchange/vignettes/strucchange-intro.pdf 

# with Chow test:
sctest(RHolyGrail_sb$srisk ~ RHolyGrail_sb$Date + RHolyGrail_sb$EU_CRR, type = "Chow", point =7)

# with OLS-CUSUM test:
sctest(RHolyGrail_sb$srisk ~ RHolyGrail_sb$Date + RHolyGrail_sb$EU_CRR, type = "OLS-CUSUM", point =7)

plot(RHolyGrail_sb)

subset_2gr <- boundary(RHolyGrail_subset1, alpha=0.05)
warnings()

############################
## Write to .CSV file
############################
write.table(RHolyGrail, file = "RHolyGrail_worked.csv", row.names=TRUE, sep = ",")


############################
## Generate nice summary statistics
############################
#taking Aberdeen Asset Management as our example

sjp.setTheme(theme = "scatter",
             geom.label.size = 3.5,
             geom.label.color = "black",
             axis.textsize = .8,
             axis.title.size = .9)

sjp.frq(RHolyGrail$country_ordinal, 
        sort.frq = "asc",
        axisTitle.x = "Country",
        axisTitle.y = "Number of Observations",
        coord.flip = TRUE,
        labelPos = "outside")

sjp.frq(RHolyGrail_subset1$firmleverage,
        RHolyGrail_subset1$days,
        type = "dens",
        showNormalCurve = TRUE,
        normalCurveAlpha = .3,
        axisTitle.x = "Time",
        axisTitle.y = "Leverage",
        labelPos = "outside")

plot(RHolyGrail_subset1$firmleverage,
     RHolyGrail_subset1$days)

############################
## Generate nice chronological graphs
############################
library(timeSeries)
library(timeDate)

par(mar = c(bottom=2, 5.1, top=3, 2.1))
plot(RHolyGrail_subset1$Date, RHolyGrail_subset1$srisk)

sjp.setTheme(theme  = "scatter",
             geom.label.size = 3.5,
             axis.title.size = .85,
             legend.size = .8,
             legend.title.size = .8,
             legend.pos = "right")

sjp.scatter(RHolyGrail_subset1$Date, 
            RHolyGrail_subset1$firmleverage, 
            showRug = TRUE, 
            title = "Aberdeen Asset Management Leverage Ratio over time", 
            axisTitle.x = "Time", 
            axisTitle.y = "Leverage Ratio", 
            showGroupFitLine = TRUE, 
            fitmethod = "loess", 
            showTotalFitLine = TRUE)

#more accurate time series plot attempt
plot(RHolyGrail$srisk)
srisk_ts <- ts(RHolyGrail$srisk)
plot.ts(srisk_ts)

